<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Towning's AI Blog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .gradient-bg-0 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-bg-1 { background: linear-gradient(135deg, #2af598 0%, #009efd 100%); }
        .gradient-bg-2 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); }
        .gradient-bg-3 { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); }
        
        .prose h1 { font-size: 2rem; font-weight: 800; margin-bottom: 1rem; color: #1f2937; line-height: 1.2; }
        .prose h2 { font-size: 1.5rem; font-weight: 700; margin-top: 2rem; margin-bottom: 1rem; color: #374151; }
        .prose p { margin-bottom: 1.25rem; line-height: 1.75; color: #4b5563; }
        .prose img { border-radius: 0.5rem; max-width: 100%; height: auto; margin: 2rem auto; display: block; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .prose pre { background: #1f2937; color: #f3f4f6; padding: 1.5rem; border-radius: 0.5rem; overflow-x: auto; margin: 1.5rem 0; }
        .prose a { color: #4f46e5; text-decoration: underline; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1.25rem; }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 min-h-screen flex flex-col">

    <!-- 顶部导航 -->
    <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-gray-100">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center cursor-pointer" onclick="renderHome()">
                    <div class="bg-indigo-600 text-white p-1.5 rounded-lg mr-2">
                        <i data-lucide="book-open" class="h-5 w-5"></i>
                    </div>
                    <span class="text-xl font-bold text-gray-900 tracking-tight">Towning's Blog</span>
                </div>
                <div class="flex space-x-4">
                    <a href="https://github.com" id="github-link" target="_blank" class="text-gray-500 hover:text-indigo-600 transition">
                        <i data-lucide="github" class="h-5 w-5"></i>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主体内容 -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-6xl">
        <div id="status-message" class="hidden mb-6"></div>
        <div id="app-container" class="fade-in min-h-[50vh]">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-pulse">
                <div class="h-64 bg-gray-200 rounded-2xl"></div>
                <div class="h-64 bg-gray-200 rounded-2xl"></div>
                <div class="h-64 bg-gray-200 rounded-2xl"></div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t border-gray-100 mt-12 py-8">
        <div class="text-center text-gray-400 text-sm">
            <p>Powered by GitHub Pages</p>
            <p class="mt-2">&copy; 2024 Towning's AI Blog</p>
        </div>
    </footer>

    <script>
        // ================= 配置区域 =================
        const CONFIG = {
            username: 'yinzhenning', // 务必修改这里
            repo: 'towning-website',           // 务必修改这里
            folder: 'posts',                  // 务必修改这里
            branch: 'main'                    // 如果你的分支是 master，请修改这里
        };
        // ===========================================

        let allPosts = [];
        const appContainer = document.getElementById('app-container');
        const statusMsg = document.getElementById('status-message');

        lucide.createIcons();
        document.getElementById('github-link').href = `https://github.com/${CONFIG.username}/${CONFIG.repo}`;

        async function init() {
            try {
                const apiUrl = `https://api.github.com/repos/${CONFIG.username}/${CONFIG.repo}/contents/${CONFIG.folder}`;
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    if (response.status === 404) throw new Error(`找不到 '${CONFIG.folder}' 文件夹。请检查 CONFIG 配置。`);
                    throw new Error("连接 GitHub 失败，请刷新重试。");
                }

                const files = await response.json();
                const validFiles = files.filter(f => f.name.toLowerCase().endsWith('.md') || f.name.toLowerCase().endsWith('.pdf'));

                if (validFiles.length === 0) {
                    appContainer.innerHTML = `<div class="text-center text-gray-500 py-20">文件夹是空的。</div>`;
                    return;
                }

                const promises = validFiles.map(async (file) => {
                    // 构建 GitHub Pages 的访问链接 (用于显示 PDF)
                    // 使用 encodeURIComponent 处理中文文件名
                    const pagesUrl = `https://${CONFIG.username}.github.io/${CONFIG.repo}/${CONFIG.folder}/${encodeURIComponent(file.name)}`;
                    // 构建 Raw 链接 (用于 Markdown 下载或备用)
                    const rawUrl = `https://raw.githubusercontent.com/${CONFIG.username}/${CONFIG.repo}/${CONFIG.branch}/${file.path}`;
                    
                    const isPdf = file.name.toLowerCase().endsWith('.pdf');

                    if (isPdf) {
                        return {
                            id: file.name,
                            title: file.name.replace('.pdf', '').replace(/_/g, ' '),
                            summary: 'PDF 文档 · 支持在线预览与下载',
                            image: null,
                            content: pagesUrl, // 主要预览链接
                            rawUrl: rawUrl,    // 备用链接
                            type: 'pdf'
                        };
                    } else {
                        const res = await fetch(rawUrl);
                        const text = await res.text();
                        const post = parseSmartPost(text, file.name);
                        post.type = 'markdown';
                        return post;
                    }
                });

                allPosts = await Promise.all(promises);
                renderHome();

            } catch (err) {
                appContainer.innerHTML = '';
                statusMsg.classList.remove('hidden');
                statusMsg.innerHTML = `<div class="bg-red-50 text-red-600 p-4 rounded-lg text-center">错误: ${err.message} <br> <small class="text-gray-500">请检查代码顶部的 CONFIG 用户名和仓库名是否正确。</small></div>`;
            }
        }

        function parseSmartPost(content, filename) {
            const post = { id: filename, content: content, title: '', summary: '', image: null };
            const titleMatch = content.match(/^#\s+(.+)$/m);
            post.title = titleMatch ? titleMatch[1].trim() : filename.replace('.md', '').replace(/_/g, ' ');
            const imgMatch = content.match(/!\[.*?\]\((.*?)\)/);
            if (imgMatch) post.image = imgMatch[1];
            let plainText = content.replace(/!\[.*?\]\(.*?\)/g, '').replace(/#+\s.+/g, '').replace(/```[\s\S]*?```/g, '').replace(/(\*\*|__)(.*?)\1/g, '$2').replace(/\n/g, ' ').trim();
            post.summary = plainText.substring(0, 100) + '...';
            return post;
        }

        function renderHome() {
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">';
            allPosts.forEach((post, index) => {
                let bgClass = post.type === 'pdf' ? 'bg-gradient-to-br from-rose-100 to-rose-200' : `gradient-bg-${(post.title.length + index) % 4}`;
                let iconHtml = post.image 
                    ? `<div class="h-48 w-full overflow-hidden"><img src="${post.image}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500"></div>`
                    : `<div class="h-48 w-full ${bgClass} flex items-center justify-center text-white opacity-90"><i data-lucide="${post.type === 'pdf' ? 'file-text' : 'file-edit'}" class="w-12 h-12 opacity-50"></i></div>`;

                html += `
                    <article class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-xl transition-all duration-300 group cursor-pointer flex flex-col h-full" onclick="renderPost('${post.id}')">
                        ${iconHtml}
                        <div class="p-6 flex flex-col flex-grow">
                            <h3 class="text-xl font-bold text-gray-900 mb-2 group-hover:text-indigo-600 transition">${post.title}</h3>
                            <div class="flex items-center space-x-2 mb-3">
                                <span class="px-2 py-0.5 rounded text-xs font-medium ${post.type === 'pdf' ? 'bg-red-100 text-red-600' : 'bg-indigo-100 text-indigo-600'}">
                                    ${post.type === 'pdf' ? 'PDF' : '文章'}
                                </span>
                            </div>
                            <p class="text-gray-500 text-sm line-clamp-3 mb-4 flex-grow">${post.summary}</p>
                        </div>
                    </article>
                `;
            });
            html += '</div>';
            appContainer.innerHTML = html;
            lucide.createIcons();
        }

        function renderPost(id) {
            const post = allPosts.find(p => p.id === id);
            if (!post) return;

            let contentBody = '';

            if (post.type === 'pdf') {
                // PDF 增强版显示逻辑
                contentBody = `
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r">
                        <div class="flex">
                            <div class="flex-shrink-0"><i data-lucide="alert-circle" class="h-5 w-5 text-yellow-400"></i></div>
                            <div class="ml-3">
                                <p class="text-sm text-yellow-700">
                                    如果你刚上传文件，预览可能需要 <strong>1-3分钟</strong> 才能生效（GitHub 需要时间部署）。
                                    <br>如果下方显示空白或报错，请点击“备用预览”或直接下载。
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 主预览区 (iframe) -->
                    <div class="w-full h-[80vh] bg-gray-100 rounded-xl overflow-hidden mb-6 border border-gray-200 shadow-inner relative">
                        <iframe src="${post.content}" class="w-full h-full" frameborder="0">
                            <p>您的浏览器不支持 iframe，请下载查看。</p>
                        </iframe>
                    </div>

                    <!-- 操作按钮区 -->
                    <div class="flex flex-wrap justify-center gap-4">
                        <a href="${post.content}" target="_blank" class="flex items-center px-6 py-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition">
                            <i data-lucide="external-link" class="w-4 h-4 mr-2"></i> 原网页打开
                        </a>
                         <a href="https://docs.google.com/viewer?url=${encodeURIComponent(post.rawUrl)}&embedded=true" target="_blank" class="flex items-center px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-full hover:bg-gray-50 transition">
                            <i data-lucide="eye" class="w-4 h-4 mr-2"></i> 谷歌预览 (备用)
                        </a>
                        <a href="${post.content}" download class="flex items-center px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-full hover:bg-gray-50 transition">
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i> 下载文件
                        </a>
                    </div>
                `;
            } else {
                contentBody = `<article class="bg-white rounded-3xl shadow-lg border border-gray-100 p-8 md:p-12"><div class="prose prose-lg prose-indigo max-w-none">${marked.parse(post.content)}</div></article>`;
            }
            
            appContainer.innerHTML = `
                <div class="max-w-4xl mx-auto animate-fade-in">
                    <button onclick="renderHome()" class="mb-6 flex items-center text-gray-500 hover:text-indigo-600 transition bg-white px-4 py-2 rounded-full shadow-sm border border-gray-100">
                        <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> 返回列表
                    </button>
                    ${post.type === 'markdown' ? `<h1 class="text-3xl font-extrabold text-gray-900 mb-8 text-center">${post.title}</h1>` : `<h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">${post.title}</h1>`}
                    ${contentBody}
                </div>
            `;
            window.scrollTo(0, 0);
            lucide.createIcons();
        }

        init();
    </script>
</body>
</html>